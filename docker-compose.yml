# AI Flight Recorder - Demo Orchestration
# docker-compose up to start full demo environment

version: '3.8'

services:
  # Edge device (simulating Raspberry Pi 4)
  edge:
    build:
      context: .
      dockerfile: Dockerfile.edge
    container_name: flight-recorder-edge
    # Resource constraints to simulate Pi 4
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.5'
    volumes:
      - edge-data:/data
    environment:
      - TENANT_ID=edge-drone-001
      - RECEIPTS_FILE=/data/receipts.jsonl
    networks:
      - flight-network
    # Can disconnect network for offline demo
    # docker network disconnect flight-network flight-recorder-edge
    restart: unless-stopped
    command: ["python", "cli.py", "--run", "1000"]

  # Ground control (dashboard + verification)
  ground:
    build:
      context: .
      dockerfile: Dockerfile.ground
    container_name: flight-recorder-ground
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
    volumes:
      - ground-data:/data
      - edge-data:/edge-data:ro  # Read-only access to edge data
    environment:
      - TENANT_ID=ground-control-001
      - RECEIPTS_FILE=/data/receipts.jsonl
      - EDGE_RECEIPTS=/edge-data/receipts.jsonl
    ports:
      - "8501:8501"  # Streamlit dashboard
      - "8000:8000"  # Verification API
    networks:
      - flight-network
    depends_on:
      - edge
    restart: unless-stopped

  # Demo runner (optional - runs demos in sequence)
  demo:
    build:
      context: .
      dockerfile: Dockerfile.edge
    container_name: flight-recorder-demo
    volumes:
      - demo-data:/data
    environment:
      - TENANT_ID=demo-device-001
    networks:
      - flight-network
    profiles:
      - demo  # Only start with: docker-compose --profile demo up
    command: ["python", "demo/tamper_demo.py"]

networks:
  flight-network:
    driver: bridge
    # For offline demo, can disconnect edge:
    # docker network disconnect flight-network flight-recorder-edge

volumes:
  edge-data:
    driver: local
  ground-data:
    driver: local
  demo-data:
    driver: local

# Usage:
#
# Start full environment:
#   docker-compose up -d
#
# View dashboard:
#   Open http://localhost:8501
#
# Run tamper demo:
#   docker-compose --profile demo up demo
#
# Simulate offline edge:
#   docker network disconnect ai-flight-recorder_flight-network flight-recorder-edge
#   # ... wait for some decisions ...
#   docker network connect ai-flight-recorder_flight-network flight-recorder-edge
#
# View edge logs:
#   docker logs -f flight-recorder-edge
#
# Stop all:
#   docker-compose down
